SET OPTIMIZER_TRACE_MAX_MEM_SIZE=1000000;
CREATE TABLE t1 (
pk INT, col_int_key INT,
col_varchar_key VARCHAR(1), col_varchar_nokey VARCHAR(1)
);
INSERT INTO t1 VALUES
(10,7,'v','v'),(11,0,'s','s'),(12,9,'l','l'),(13,3,'y','y'),(14,4,'c','c'),
(15,2,'i','i'),(16,5,'h','h'),(17,3,'q','q'),(18,1,'a','a'),(19,3,'v','v'),
(20,6,'u','u'),(21,7,'s','s'),(22,5,'y','y'),(23,1,'z','z'),(24,204,'h','h'),
(25,224,'p','p'),(26,9,'e','e'),(27,5,'i','i'),(28,0,'y','y'),(29,3,'w','w');
CREATE TABLE t2 (
pk INT, col_int_key INT,
col_varchar_key VARCHAR(1), col_varchar_nokey VARCHAR(1),
PRIMARY KEY (pk)
);
INSERT INTO t2 VALUES
(1,4,'b','b'),(2,8,'y','y'),(3,0,'p','p'),(4,0,'f','f'),(5,0,'p','p'),
(6,7,'d','d'),(7,7,'f','f'),(8,5,'j','j'),(9,3,'e','e'),(10,188,'u','u'),
(11,4,'v','v'),(12,9,'u','u'),(13,6,'i','i'),(14,1,'x','x'),(15,5,'l','l'),
(16,6,'q','q'),(17,2,'n','n'),(18,4,'r','r'),(19,231,'c','c'),(20,4,'h','h'),
(21,3,'k','k'),(22,3,'t','t'),(23,7,'t','t'),(24,6,'k','k'),(25,7,'g','g'),
(26,9,'z','z'),(27,4,'n','n'),(28,4,'j','j'),(29,2,'l','l'),(30,1,'d','d'),
(31,2,'t','t'),(32,194,'y','y'),(33,2,'i','i'),(34,3,'j','j'),(35,8,'r','r'),
(36,4,'b','b'),(37,9,'o','o'),(38,4,'k','k'),(39,5,'a','a'),(40,5,'f','f'),
(41,9,'t','t'),(42,3,'c','c'),(43,8,'c','c'),(44,0,'r','r'),(45,98,'k','k'),
(46,3,'l','l'),(47,1,'o','o'),(48,0,'t','t'),(49,189,'v','v'),(50,8,'x','x'),
(51,3,'j','j'),(52,3,'x','x'),(53,9,'k','k'),(54,6,'o','o'),(55,8,'z','z'),
(56,3,'n','n'),(57,9,'c','c'),(58,5,'d','d'),(59,9,'s','s'),(60,2,'j','j'),
(61,2,'w','w'),(62,5,'f','f'),(63,8,'p','p'),(64,6,'o','o'),(65,9,'f','f'),
(66,0,'x','x'),(67,3,'q','q'),(68,6,'g','g'),(69,5,'x','x'),(70,8,'p','p'),
(71,2,'q','q'),(72,120,'q','q'),(73,25,'v','v'),(74,1,'g','g'),(75,3,'l','l'),
(76,1,'w','w'),(77,3,'h','h'),(78,153,'c','c'),(79,5,'o','o'),(80,9,'o','o'),
(81,1,'v','v'),(82,8,'y','y'),(83,7,'d','d'),(84,6,'p','p'),(85,2,'z','z'),
(86,4,'t','t'),(87,7,'b','b'),(88,3,'y','y'),(89,8,'k','k'),(90,4,'c','c'),
(91,6,'z','z'),(92,1,'t','t'),(93,7,'o','o'),(94,1,'u','u'),(95,0,'t','t'),
(96,2,'k','k'),(97,7,'u','u'),(98,2,'b','b'),(99,1,'m','m'),(100,5,'o','o');
SET OPTIMIZER_TRACE="enabled=on",END_MARKERS_IN_JSON=on;
SELECT SUM(alias2.col_varchar_nokey) , alias2.pk AS field2 FROM t1 AS alias1
STRAIGHT_JOIN t2 AS alias2 ON alias2.pk = alias1.col_int_key WHERE alias1.pk
GROUP BY field2 ORDER BY alias1.col_int_key,alias2.pk ;
SUM(alias2.col_varchar_nokey)	field2
0	1
0	2
0	3
0	4
0	5
0	6
0	7
0	9
Warnings:
Warning	1292	Truncated incorrect DOUBLE value: 'f'
Warning	1292	Truncated incorrect DOUBLE value: 'e'
Warning	1292	Truncated incorrect DOUBLE value: 'p'
Warning	1292	Truncated incorrect DOUBLE value: 'f'
Warning	1292	Truncated incorrect DOUBLE value: 'y'
Warning	1292	Truncated incorrect DOUBLE value: 'p'
Warning	1292	Truncated incorrect DOUBLE value: 'p'
Warning	1292	Truncated incorrect DOUBLE value: 'b'
Warning	1292	Truncated incorrect DOUBLE value: 'p'
Warning	1292	Truncated incorrect DOUBLE value: 'd'
Warning	1292	Truncated incorrect DOUBLE value: 'f'
Warning	1292	Truncated incorrect DOUBLE value: 'p'
Warning	1292	Truncated incorrect DOUBLE value: 'b'
Warning	1292	Truncated incorrect DOUBLE value: 'e'
Warning	1292	Truncated incorrect DOUBLE value: 'p'
Warning	1292	Truncated incorrect DOUBLE value: 'p'
SELECT * FROM INFORMATION_SCHEMA.OPTIMIZER_TRACE;
QUERY	OPT_TRACE
SHOW WARNINGS	"steps": []
SELECT SUM(alias2.col_varchar_nokey) , alias2.pk AS field2 FROM t1 AS alias1
STRAIGHT_JOIN t2 AS alias2 ON alias2.pk = alias1.col_int_key WHERE alias1.pk
GROUP BY field2 ORDER BY alias1.col_int_key,alias2.pk	"steps": [
  {
    "join_preparation": {
      "select #": 1,
      "steps": [
        {
          "expanded_query": "select sum(`alias2`.`col_varchar_nokey`) AS `SUM(alias2.col_varchar_nokey)`,`alias2`.`pk` AS `field2` from (`test`.`t1` `alias1` straight_join `test`.`t2` `alias2` on(`alias2`.`pk` = `alias1`.`col_int_key`)) where `alias1`.`pk` <> 0 group by `alias2`.`pk` order by `alias1`.`col_int_key`,`alias2`.`pk`"
        }
      ] /* steps */
    } /* join_preparation */
  },
  {
    "join_optimization": {
      "select #": 1,
      "steps": [
        {
          "condition_processing": {
            "condition": "WHERE",
            "original_condition": "`alias1`.`pk` <> 0 and `alias2`.`pk` = `alias1`.`col_int_key`",
            "steps": [
              {
                "transformation": "equality_propagation",
                "subselect_evaluation": [],
                "resulting_condition": "`alias1`.`pk` <> 0 and multiple equal(`alias2`.`pk`, `alias1`.`col_int_key`)"
              },
              {
                "transformation": "constant_propagation",
                "subselect_evaluation": [],
                "resulting_condition": "`alias1`.`pk` <> 0 and multiple equal(`alias2`.`pk`, `alias1`.`col_int_key`)"
              },
              {
                "transformation": "trivial_condition_removal",
                "subselect_evaluation": [],
                "resulting_condition": "`alias1`.`pk` <> 0 and multiple equal(`alias2`.`pk`, `alias1`.`col_int_key`)"
              }
            ] /* steps */
          } /* condition_processing */
        },
        {
          "condition_processing": {
            "condition": "WHERE",
            "original_condition": null,
            "steps": [
              {
                "transformation": "equality_propagation",
                "resulting_condition": null
              }
            ] /* steps */
          } /* condition_processing */
        },
        {
          "table_dependencies": [
            {
              "table": "`test`.`t1` `alias1`",
              "row_may_be_null": false,
              "depends_on_map_bits": []
            },
            {
              "table": "`test`.`t2` `alias2`",
              "row_may_be_null": false,
              "depends_on_map_bits": [0]
            }
          ] /* table_dependencies */
        },
        {
          "ref_optimizer_key_uses": [
            {
              "table": "`test`.`t2` `alias2`",
              "field": "pk",
              "equals": "`test`.`alias1`.`col_int_key`",
              "null_rejecting": true
            }
          ] /* ref_optimizer_key_uses */
        },
        {
          "rows_estimation": [
            {
              "table": "`test`.`t1` `alias1`",
              "range_analysis": {
                "table_scan": {
                  "rows": 20,
                  "cost": 8.1977
                } /* table_scan */
              } /* range_analysis */
            },
            {
              "table": "`test`.`t2` `alias2`",
              "const_keys_added": {
                "keys": ["PRIMARY"],
                "cause": "group_by"
              } /* const_keys_added */,
              "range_analysis": {
                "table_scan": {
                  "rows": 100,
                  "cost": 24.588
                } /* table_scan */,
                "potential_range_indexes": [
                  {
                    "index": "PRIMARY",
                    "usable": true,
                    "key_parts": ["pk"]
                  }
                ] /* potential_range_indexes */,
                "group_index_range": {
                  "chosen": false,
                  "cause": "not_single_table"
                } /* group_index_range */
              } /* range_analysis */
            }
          ] /* rows_estimation */
        },
        {
          "considered_execution_plans": [
            {
              "plan_prefix": [],
              "table": "`test`.`t1` `alias1`",
              "best_access_path": {
                "considered_access_paths": [
                  {
                    "rows_to_scan": 20,
                    "resulting_rows": 20,
                    "access_type": "scan",
                    "cost": 6.0977,
                    "chosen": true
                  }
                ] /* considered_access_paths */
              } /* best_access_path */,
              "condition_selectivity": -2e-12,
              "rows_for_plan": 20,
              "cost_for_plan": 6.0977,
              "rest_of_plan": [
                {
                  "plan_prefix": ["`test`.`t1` `alias1`"],
                  "table": "`test`.`t2` `alias2`",
                  "best_access_path": {
                    "considered_access_paths": [
                      {
                        "access_type": "eq_ref",
                        "index": "PRIMARY",
                        "rows": 1,
                        "cost": 20.2,
                        "chosen": true
                      },
                      {
                        "rows_to_scan": 100,
                        "heuristic": "filter_25%",
                        "resulting_rows": 75,
                        "access_type": "scan",
                        "using_join_cache": true,
                        "buffers_needed": 1,
                        "cost": 307.49,
                        "chosen": false
                      }
                    ] /* considered_access_paths */
                  } /* best_access_path */,
                  "condition_selectivity": -2e-12,
                  "rows_for_plan": 20,
                  "cost_for_plan": 30.098,
                  "chosen": true
                }
              ] /* rest_of_plan */
            }
          ] /* considered_execution_plans */
        },
        {
          "fixing_semijoin_strategies_for_the_picked_join_order": []
        },
        {},
        {
          "attaching_conditions_to_tables": {
            "original_condition": "`alias2`.`pk` = `alias1`.`col_int_key` and `alias1`.`pk` <> 0",
            "attached_conditions_computation": [],
            "attached_conditions_summary": [
              {
                "table": "alias1",
                "cond": "`alias1`.`pk` <> 0 and `alias1`.`col_int_key` is not null"
              },
              {
                "table": "alias2",
                "cond": null
              }
            ] /* attached_conditions_summary */
          } /* attaching_conditions_to_tables */
        },
        {
          "optimizing_distinct_group_by_order_by": {
            "simplifying_group/order_list": {
              "original_clause": "`alias1`.`col_int_key`,`alias2`.`pk`",
              "items": [
                {
                  "item": "`alias1`.`col_int_key`"
                },
                {
                  "item": "`alias2`.`pk`",
                  "eq_ref_to_preceding_items": true
                }
              ] /* items */,
              "resulting_clause_is_simple": true,
              "resulting_clause": "`alias1`.`col_int_key`"
            } /* simplifying_group/order_list */,
            "simplifying_group/order_list": {
              "original_clause": "`alias2`.`pk`",
              "items": [
                {
                  "item": "`alias2`.`pk`",
                  "can_use_multiple_equalities_to_remove_temp_table": true
                }
              ] /* items */,
              "resulting_clause_is_simple": true,
              "resulting_clause": "`alias2`.`pk`"
            } /* simplifying_group/order_list */
          } /* optimizing_distinct_group_by_order_by */
        },
        {
          "refine_plan": [
            {
              "table": "`test`.`t1` `alias1`"
            },
            {
              "table": "`test`.`t2` `alias2`"
            }
          ] /* refine_plan */
        },
        {
          "reconsidering_access_paths_for_index_ordering": {
            "index_order_summary": {
              "table": "`test`.`t1` `alias1`",
              "index_provides_order": false,
              "order_direction": "undefined",
              "plan_changed": false
            } /* index_order_summary */
          } /* reconsidering_access_paths_for_index_ordering */
        },
        {
          "considering_tmp_tables": [
            {
              "adding_tmp_table_in_plan_at_position": 2,
              "cause": "distinct_or_sort_too_complicated",
              "write_method": "continuously_update_group_row_using_keys"
            },
            {
              "adding_sort_to_table_in_plan_at_position": [2]
            }
          ] /* considering_tmp_tables */
        }
      ] /* steps */
    } /* join_optimization */
  },
  {
    "join_execution": {
      "select#": 1,
      "steps": [
        {
          "setting_up_tmp_table_for_aggregation": {
            "tmp_table_info": {
              "table": "intermediate_tmp_table",
              "in_plan_at_position": [2],
              "columns": 3,
              "rec_length": 18,
              "key_length": 4,
              "makes_grouped_rows": true,
              "cannot_insert_duplicates": false,
              "location": "MEMORY",
              "row_limit_estimate": 58254
            } /* tmp_table_info */
          } /* setting_up_tmp_table_for_aggregation */
        },
        {
          "sorting_table_in_plan_at_position": [2],
          "filesort_information": [
            {
              "direction": "asc",
              "table": "intermediate_tmp_table",
              "field": "tmp_table_column"
            }
          ] /* filesort_information */,
          "filesort_priority_queue_optimization": {
            "usable": false,
            "cause": "no limit"
          } /* filesort_priority_queue_optimization */,
          "filesort_execution": [],
          "filesort_summary": {
            "memory_available": 262144,
            "sort_length": 13,
            "rec_length": 13,
            "max_keys_per_buffer": 18,
            "num_rows_estimate": 18,
            "num_rows_found": 8,
            "num_examined_rows": 8,
            "num_initial_buffpeks_spilled_to_disk": 0,
            "sort_buffer_size": 378,
            "sort_algorithm": "my_qsort2"
          } /* filesort_summary */
        }
      ] /* steps */
    } /* join_execution */
  }
] /* steps */
DROP TABLE t1, t2;
